{% extends "base.html" %}

{% block content %}
{% if user %}
<div class="row">
    <div class="col-md-8">
        <h3>Device Map</h3>
        <div id="map" style="height: 500px;"></div>
    </div>
    <div class="col-md-4">
        <h3>Live Weather</h3>
        <div id="weather-details">
            <p>Click on a device to see live details.</p>
            <p><strong>Temperature:</strong> <span id="temp">--</span> &deg;C</p>
            <p><strong>Pressure:</strong> <span id="pressure">--</span> hPa</p>
            <p><strong>Humidity:</strong> <span id="humidity">--</span> %</p>
            <p><strong>Rain Chance (1hr):</strong> <span id="rain">--</span> %</p>
        </div>
    </div>
</div>
{% else %}
<div class="container mt-5">
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Welcome to RainWatch</h1>
            <p class="col-md-8 fs-4">Monitor weather conditions from various devices in real-time. Please log in or sign up to view the device map and live weather data.</p>
            <a href="/login" class="btn btn-primary btn-lg">Login</a>
            <a href="/signup" class="btn btn-secondary btn-lg">Sign Up</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var map = L.map('map').setView([20, 0], 2); // Default view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        fetch('/api/devices')
            .then(response => response.json())
            .then(devices => {
                if (devices.length > 0) {
                    map.setView([devices[0].latitude, devices[0].longitude], 6);
                }
                devices.forEach(device => {
                    var marker = L.marker([device.latitude, device.longitude]).addTo(map);
                    marker.bindPopup(`<b>${device.name}</b>`).on('click', function(e) {
                        // In a real app, you'd fetch live data for this device.
                        // For now, we'll just display its location.
                        document.getElementById('weather-details').innerHTML = `
                            <h4>${device.name}</h4>
                            <p>Details would be loaded here.</p>
                        `;
                    });
                });
            });
    });
</script>
{% endif %}
{% endblock %}