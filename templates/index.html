{% extends "base.html" %}

{% block content %}
{% if user %}
<div class="row">
    <div class="col-md-8">
        <h3>Device Map</h3>
        <div id="map" style="height: 500px;"></div>
    </div>
    <div class="col-md-4">
        <h3>Live Weather</h3>
        <div id="weather-details">
            <p>Click on a device to see live details.</p>
            <p><strong>Temperature:</strong> <span id="temp">--</span> &deg;C</p>
            <p><strong>Pressure:</strong> <span id="pressure">--</span> hPa</p>
            <p><strong>Humidity:</strong> <span id="humidity">--</span> %</p>
            <p><strong>Rain Chance (1hr):</strong> <span id="rain">--</span> %</p>
        </div>
    </div>
</div>
{% else %}
<div class="container mt-5">
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Welcome to RainWatch</h1>
            <p class="col-md-8 fs-4">Monitor weather conditions from various devices in real-time. Please log in or sign up to view the device map and live weather data.</p>
            <a href="/login" class="btn btn-primary btn-lg">Login</a>
            <a href="/signup" class="btn btn-secondary btn-lg">Sign Up</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var map = L.map('map').setView([20, 0], 2); // Default view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to fetch and display device data
        function fetchDeviceData(deviceId, deviceName) {
            // Show loading state
            document.getElementById('weather-details').innerHTML = `
                <h4>${deviceName}</h4>
                <p>Loading latest readings...</p>
                <p><strong>Temperature:</strong> <span id="temp">--</span> &deg;C</p>
                <p><strong>Pressure:</strong> <span id="pressure">--</span> hPa</p>
                <p><strong>Humidity:</strong> <span id="humidity">--</span> %</p>
                <p><strong>Rain Chance (1hr):</strong> <span id="rain">--</span> %</p>
            `;

            fetch(`/api/devices/${deviceId}/latest`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch device data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Format timestamp if available
                    let lastUpdated = '';
                    if (data.timestamp) {
                        const date = new Date(data.timestamp);
                        lastUpdated = `<p><small>Last updated: ${date.toLocaleString()}</small></p>`;
                    }

                    // Update the weather details with real data
                    document.getElementById('weather-details').innerHTML = `
                        <h4>${data.device_name}</h4>
                        ${lastUpdated}
                        <p><strong>Temperature:</strong> <span id="temp">${data.temperature !== null ? data.temperature.toFixed(1) : '--'}</span> &deg;C</p>
                        <p><strong>Pressure:</strong> <span id="pressure">${data.pressure !== null ? data.pressure.toFixed(1) : '--'}</span> hPa</p>
                        <p><strong>Humidity:</strong> <span id="humidity">${data.humidity !== null ? data.humidity.toFixed(1) : '--'}</span> %</p>
                        <p><strong>Rain Chance (1hr):</strong> <span id="rain">${data.rain_chance}</span> %</p>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching device data:', error);
                    document.getElementById('weather-details').innerHTML = `
                        <h4>${deviceName}</h4>
                        <p class="text-danger">Error loading data. Please try again.</p>
                        <p><strong>Temperature:</strong> <span id="temp">--</span> &deg;C</p>
                        <p><strong>Pressure:</strong> <span id="pressure">--</span> hPa</p>
                        <p><strong>Humidity:</strong> <span id="humidity">--</span> %</p>
                        <p><strong>Rain Chance (1hr):</strong> <span id="rain">--</span> %</p>
                    `;
                });
        }

        fetch('/api/devices')
            .then(response => response.json())
            .then(devices => {
                if (devices.length > 0) {
                    map.setView([devices[0].latitude, devices[0].longitude], 6);
                }
                devices.forEach(device => {
                    var marker = L.marker([device.latitude, device.longitude]).addTo(map);
                    marker.bindPopup(`<b>${device.name}</b>`).on('click', function(e) {
                        // Fetch live data for this device
                        fetchDeviceData(device.id, device.name);
                    });
                });
            });
    });
</script>
{% endif %}
{% endblock %}